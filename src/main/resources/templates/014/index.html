<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="../../static/css/index.css">
    <link rel="stylesheet" href="/static/lib/layui-v2.8.17/css/layui.css" media="all">
    <title>数字化分析</title>
<!--    <script src="../../static/js/jquery-2.2.1.min.js"></script>旧版本-->
    <script src="/static/js/http_ajax.googleapis.com_ajax_libs_jquery_3.5.1_jquery.js"></script>
    <script src="../../static/js/rem.js"></script>
    <script src="../../static/js/echarts.min.js"></script>
    <script src="../../static/js/index.js"></script>
    <script src="/static/lib/layui-v2.8.17/layui.js" charset="utf-8"></script>
    <style>
    </style>
</head>
<body>
    <div class="t_container">
        <main class="t_main">
            <header class="t_title">
                <h2>各客户库存概况</h2>
                <div>
                    <input type="date" id="cutoff-date">
                    <select id="depository-select">
                        <option value="ALL">所有厂区</option>
                        <option value="SAB">SAB</option>
                        <option value="ZAB">ZAB</option>
                    </select>
                    <select id="state-select">
                        <option value="ALL">所有状态</option>
                        <option value="正常">正常</option>
                        <option value="死库">死库</option>
                    </select>
                </div>
            </header>
            <div class="t_box">
                <div id="chart_2" style="width: 100%; height: 100%;"></div>
            </div>
        </main>
        <main class="t_main">
            <div class="t_box_2">
                <header class="t_title">
                    <h1>库存产品状况预警</h1>
                    <div style="display: none">
                        <label class="layui-form-label">状态选择</label>
                        <div class="layui-input-inline">
                            <select name="state" id="stateSelect">
                                <option value="正常">正常</option>
                                <option value="死库">死库</option>
                                <option value="ALL">全部</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-input-inline" style="position: relative; z-index: 999;">
                        <input type="text" name="time" id="date" placeholder="选择日期区间" autocomplete="off" class="layui-input" >
                    </div>
                    <table class="layui-hide" id="currentTableId" lay-filter="currentTableFilter"></table>
                </header>
            </div>
        </main>
    </div>
    <script>
        // 添加事件监听器，当日期或厂区改变时，更新图表数据
        document.getElementById('cutoff-date').addEventListener('change', updateChartData);
        document.getElementById('depository-select').addEventListener('change', updateChartData);
        document.getElementById('state-select').addEventListener('change', updateChartData);

        function updateChartData() {
            const selectedDate = document.getElementById('cutoff-date').value;
            const selectedDepository = document.getElementById('depository-select').value;
            const selectedState = document.getElementById('state-select').value;
            if (selectedDate) {
                fetchChartDataAndUpdateEchart(selectedDate, selectedDepository, selectedState);
            }
        }
        function loadInitialChartData() {
            const today = new Date().toISOString().split('T')[0]; // 获取今天的日期，格式为YYYY-MM-DD
            document.getElementById('cutoff-date').value = today; // 设置日期选择器为今天
            updateChartData(); // 使用今天的日期加载图表数据
        }
        // 获取并更新图表数据的函数，根据指定的截止日期
        function fetchChartDataAndUpdateEchart(cutoffDate, depository, state) {
            // 构建请求URL，根据是否选择了“所有厂区”来调整参数
            let url = `/bearingRecords/customer-status?cutoffDate=${cutoffDate}`;
            if (depository !== 'ALL') {
                url += `&depository=${depository}`;
            }
            if (state !== 'ALL') {
                url += `&state=${state}`;
            }
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    echart_2(data); // 使用获取的数据更新图表
                })
                .catch(error => console.error('Error fetching chart data:', error));
        }

        function echart_2(chartData) {
            // 基于准备好的dom，初始化echarts实例
            var myChart = echarts.init(document.getElementById('chart_2'));
            const customers = [...new Set(chartData.map(item => item.customer))]; // 假设chartData是您的数据
            const colors = customers.map(() => generateRandomColor());
            // 处理从后端获取的数据
            const yAxisData = chartData.map(item => item.customer); // 顾客名称
            const totalLA = chartData.reduce((sum, item) => sum + item.LA_quantity, 0);
            const totalLB = chartData.reduce((sum, item) => sum + item.LB_quantity, 0);
            const totals = chartData.reduce((acc, item) => {
                acc.totalLA += item.LA_quantity;
                acc.totalLB += item.LB_quantity;
                return acc;
            }, { totalLA: 0, totalLB: 0 });
            const legendData = yAxisData;
            const barSeriesData = chartData.map(item => item.LA_quantity + item.LB_quantity); // 假设后端数据有LA_quantity属性
            const pieSeriesData = chartData.map(item => ({
                value: 1,
                name: item.customer, // 使用name作为饼图的名称
                LA_quantity: item.LA_quantity, // 在这里添加LB的数量
                LB_quantity: item.LB_quantity // 在这里添加LB的数量
            }));

            myChart.setOption({
                // graphic: {
                //     elements: [{
                //         type: 'image',
                //         style: {
                //             width: 30,
                //             height: 30
                //         },
                //         left: '73%',
                //         top: 'center'
                //     }]
                // },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                grid: {
                    left: '5%',
                    right: '80%',
                    top: '10%',
                    bottom: '10%',
                    containLabel: true,
                },
                xAxis: {
                    type: 'category',
                    data: ['LA', 'LB'], // X轴显示LA和LB
                    axisLine: { show: true },
                    axisLabel: {
                        show: false,
                        color: '#FFFFFF' // 设置X轴标签颜色为白色
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLine: { show: true },
                    axisLabel: { show: false, color: '#FFFFFF' }
                },
                legend: {
                    data: legendData, // 设置图例数据
                    orient: 'vertical', // 图例排列方向，垂直排列
                    right: '5%',
                    top: 'middle', // 垂直居中
                    textStyle: {
                        color: '#FFFFFF' // 设置图例文字颜色为白色
                    }
                },
                // xAxis: {
                //     type: 'value',
                //     position:'top',
                //     splitLine: {show: false},
                //     boundaryGap: [0, 0.01],
                //     axisTick: {
                //         show: false
                //     },
                //     axisLine: { show: false }, // 如果您也想隐藏轴线，可以设置为 false
                //     axisLabel: { show: false }, // 设置为false来隐藏轴的刻度标签
                // },
                // yAxis: {
                //     type: 'category',
                //     data: yAxisData,
                //     position:'left',
                //     axisTick: {
                //         show: false
                //     },
                //     splitLine: {
                //         show: false
                //     },
                //     axisLabel: {
                //         textStyle: {
                //             color: '#FFFFFF',
                //             fontSize: 12
                //         }
                //     },
                //     axisLine: {
                //         show: true,
                //         lineStyle: {
                //             color: '#6173A3'
                //         }
                //     },
                // },
                series: [
                //     {
                //         type: 'bar',
                //         itemStyle: {
                //         normal: {
                //             color: function(params) {
                //                 // 这里使用params.dataIndex来获取当前数据项的索引，然后使用该索引从colors数组中获取颜色
                //                 return colors[params.dataIndex % colors.length]; // 使用模运算确保索引不会超出数组长度
                //             },
                //             shadowBlur: 20,
                //             shadowColor: 'rgba(0, 0, 0, 0.5)'
                //         }
                //     },
                //     data: barSeriesData
                // },    上述注释为各客户具体数量，目前为LA,LB总量统计
                    {
                        name: '总量',
                        type: 'bar',
                        data: [
                            {
                                value: totals.totalLA,
                                label: {
                                    show: true,
                                    position: 'top',
                                    color: '#FFFFFF',
                                    formatter: function(params) {
                                        // 使用Intl.NumberFormat进行千分位格式化
                                        const formattedValue = new Intl.NumberFormat('en-US').format(params.value);
                                        return `外轮库存总数: \n ${formattedValue}`;
                                    }
                                },
                                itemStyle: {
                                    color: '#1f77b4' // 为总LA设置一种颜色
                                }
                            },
                            {
                                value: totals.totalLB,
                                label: {
                                    show: true,
                                    position: 'top',
                                    color: '#FFFFFF',
                                    formatter: function(params) {
                                        // 使用Intl.NumberFormat进行千分位格式化
                                        const formattedValue = new Intl.NumberFormat('en-US').format(params.value);
                                        return `内轮库存总数: \n ${formattedValue}`;
                                    }
                                },
                                itemStyle: {
                                    color: '#ff7f0e' // 为总LB设置另一种颜色
                                }
                            }
                        ],
                        itemStyle: {
                            color: function(params) {
                                // 根据条目的类型（LA或LB）为其分配颜色
                                return params.dataIndex === 0 ? '#1f77b4' : '#ff7f0e';
                            }
                        }
                    },
                    {
                        type: 'pie',
                        radius: ['50%', '77%'],
                        center: ['55%', '50%'],
                        roseType: 'radius',
                            color: function(params) {
                                // 这里使用params.dataIndex来获取当前数据项的索引，然后使用该索引从colors数组中获取颜色
                                return colors[params.dataIndex % colors.length]; // 使用模运算确保索引不会超出数组长度
                            },
                        data: pieSeriesData,
                        label: {
                            normal: {
                                rich: {
                                    nameStyle: {
                                        // 名称样式
                                        color: '#FFFFFF',
                                        align: 'left',
                                        fontSize: 13,
                                        lineHeight: 12
                                    },
                                    valueStyle: {
                                        // 数值样式
                                        color: '#FFFFFF',
                                        align: 'left',
                                        fontSize: 13,
                                        lineHeight: 12
                                    }
                                },
                                formatter: function(param) {
                                    const formatter = new Intl.NumberFormat('en-US');
                                    const LA_quantityFormatted = formatter.format(param.data.LA_quantity);
                                    const LB_quantityFormatted = formatter.format(param.data.LB_quantity);
                                    const totalLA = totals.totalLA;
                                    const totalLB = totals.totalLB;
                                    const percentage = ((param.data.LA_quantity / totalLA + param.data.LB_quantity / totalLB) / 2 * 100).toFixed(0);
                                    return [
                                        '{nameStyle|' + param.name +" "+ percentage +"%"+'}',
                                        '{valueStyle|外轮: ' + LA_quantityFormatted + '}',
                                        '{valueStyle|内轮: ' + LB_quantityFormatted + '}'
                                    ].join('\n');
                                },
                                padding: [0, 10] // 根据需要调整padding来对齐文本
                            }
                        },
                        // tooltip: {
                            //     trigger: 'item',
                            //     formatter: function(param) {
                            //         return `${param.name}: <br>外轮:${param.data.LA_quantity}<br>内轮:${param.data.LB_quantity}`;
                            //     }
                            // },
                            labelLine: {
                                normal: {
                                    length: 30, // 调整指向线的起始部分长度
                                    length2: 15, // 调整指向线从转折点到标签的部分长度
                                    smooth: 0.2, // 可以尝试启用平滑
                                    lineStyle: {
                                        color: '#FFFFFF' // 设置线条颜色为白色
                                    }
                                }
                            },
                            itemStyle: {
                            normal: {
                                shadowBlur: 30,
                                shadowColor: 'rgba(0, 0, 0, 0.4)'
                            }
                        },
                        animationType: 'scale',
                        animationEasing: 'elasticOut',
                        animationDelay: function(idx) {
                            return Math.random() * 200;
                        }
                    }
                ]
            });
        }

        // 页面加载完成后，自动加载数据
        document.addEventListener('DOMContentLoaded', loadInitialChartData);
        function generateRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }
        var tableInstance;  // 定义一个全局table变量
        function loadReport() {
            // 获取选择框和日期选择器的值
            var dates = document.getElementById('date').value.split(' - ');
            var startDate1 = dates[0];
            var endDate1 = dates[1];
            console.log(dates, "+", startDate1, '+', endDate1);
            // 获取状态选择器的值
            var state = document.getElementById('stateSelect').value;
            // 创建新的URL
            var url = `/bearingRecords/condWarn?state=${state}&startDate=${startDate1}&endDate=${endDate1}`;
            // 更新表格的URL
            tableInstance.render({
                title:"库存产品状况预警",
                elem: "#currentTableId",
                url: url,
                height: "full-50", // 设置表格高度并固定表头
                height: '500px',
                parseData: function(res) { // 将原始数据格式适配成 layui 表格组件所期望的格式
                    var filteredData = res.filter(function(record) {
                        return record.pair > 0;
                    });
                    // 对数据进行排序，将在库_LA和在库_LB的红色柱形排到上面
                    filteredData.sort(function(a, b) {
                        // 判断颜色
                        var colorA_LA = (a.入库_LA === 0 && a.出库_LA === 0) ? 1 : 0;
                        var colorA_LB = (a.入库_LB === 0 && a.出库_LB === 0) ? 1 : 0;
                        var colorB_LA = (b.入库_LA === 0 && b.出库_LA === 0) ? 1 : 0;
                        var colorB_LB = (b.入库_LB === 0 && b.出库_LB === 0) ? 1 : 0;

                        // 判断库存
                        var inStockA_LA = (a.在库_LA > 0) ? 1 : 0;
                        var inStockA_LB = (a.在库_LB > 0) ? 1 : 0;
                        var inStockB_LA = (b.在库_LA > 0) ? 1 : 0;
                        var inStockB_LB = (b.在库_LB > 0) ? 1 : 0;

                        // 排序逻辑
                        if (colorB_LA === 1 && colorB_LB === 1 && inStockB_LA === 1 && inStockA_LA === 1 && colorA_LA === 1 && colorA_LB === 1) {
                            return 1;
                        }
                        if (colorA_LA === 1 && inStockA_LA === 1) {
                            return -1;
                        } else if (colorB_LA === 1 && inStockB_LA === 1) {
                            return 1;
                        }
                        if (colorA_LB === 1 && inStockA_LB === 1) {
                            return -1;
                        } else if (colorB_LB === 1 && inStockB_LB === 1) {
                            return 1;
                        }
                        return 0;
                    });
                    return {
                        "code": 0, // 解析接口状态
                        "msg": "", // 解析提示文本
                        "count": filteredData.length, // 解析数据长度
                        "data": filteredData // 解析数据列表
                    };
                },
                toolbar: ['exports'],
                request: {
                    pageName: 'page', // 页码的参数名称，默认：page
                    limitName: 'size' // 每页数据量的参数名，默认：limit
                },
                cols: [
                    [ // 表头
                        { field: ' ', title: ' ', colspan: 1, rowspan: 1, align: 'center' },
                        { field: ' ', title: '配对', colspan: 1, rowspan: 1, hide: true, align: 'center' },
                        { field: ' ', title: '型号', colspan: 2, rowspan: 1, align: 'center' },
                        { field: ' ', title: '入库', colspan: 2, rowspan: 1, align: 'center' },
                        { field: ' ', title: '库存', colspan: 2, rowspan: 1, align: 'center' },
                        { field: ' ', title: '出库', colspan: 2, rowspan: 1, align: 'center' },
                    ], [
                        { field: '客户', title: '客户', colspan: 1, rowspan: 1, align: 'center' },
                        { field: 'pair', title: 'Pair', colspan: 1, rowspan: 1, hide: true, align: 'center' },
                        { field: '型号_LA', title: '外轮', align: 'center' },
                        { field: '型号_LB', title: '内轮', align: 'center' },
                        { field: '入库_LA', title: '入库LA', templet: function(d) {
                                const barWidth = Math.min(100, Math.log10(d.入库_LA + 1) * 10); // 使用对数比例计算宽度
                                return `<div style="display: flex; align-items: center;">
                        <div style="width: ${barWidth}px; height: 20px; background-color: #26b510;"></div>
                        <div style="margin-left: 5px;">${d.入库_LA}</div>
                    </div>`;
                            }, align: 'center' },
                        { field: '入库_LB', title: '入库LB', templet: function(d) {
                                const barWidth = Math.min(100, Math.log10(d.入库_LB + 1) * 10); // 使用对数比例计算宽度
                                return `<div style="display: flex; align-items: center;">
                        <div style="width: ${barWidth}px; height: 20px; background-color: #26b510;"></div>
                        <div style="margin-left: 5px;">${d.入库_LB}</div>
                    </div>`;
                            }, align: 'center' },
                        { field: '在库_LA', title: '在库LA', templet: function(d) {
                                const barWidth = Math.min(100, Math.log10(d.在库_LA + 1) * 10); // 使用对数比例计算宽度
                                const barColor = (d.入库_LA === 0 && d.出库_LA === 0) ? '#d5270f' : '#26b510'; // 根据条件设置颜色
                                return `<div style="display: flex; align-items: center;">
                        <div style="width: ${barWidth}px; height: 20px; background-color: ${barColor};"></div>
                        <div style="margin-left: 5px;">${d.在库_LA}</div>
                    </div>`;
                            }, align: 'center' },
                        { field: '在库_LB', title: '在库LB', templet: function(d) {
                                const barWidth = Math.min(100, Math.log10(d.在库_LB + 1) * 10); // 使用对数比例计算宽度
                                const barColor = (d.入库_LB === 0 && d.出库_LB === 0) ? '#d5270f' : '#26b510'; // 根据条件设置颜色
                                return `<div style="display: flex; align-items: center;">
                        <div style="width: ${barWidth}px; height: 20px; background-color: ${barColor};"></div>
                        <div style="margin-left: 5px;">${d.在库_LB}</div>
                    </div>`;
                            }, align: 'center' },
                        { field: '出库_LA', title: '出库LA', templet: function(d) {
                                const barWidth = Math.min(100, Math.log10(d.出库_LA + 1) * 10); // 使用对数比例计算宽度
                                return `<div style="display: flex; align-items: center;">
                        <div style="width: ${barWidth}px; height: 20px; background-color: #26b510;"></div>
                        <div style="margin-left: 5px;">${d.出库_LA}</div>
                    </div>`;
                            }, align: 'center' },
                        { field: '出库_LB', title: '出库LB', templet: function(d) {
                                const barWidth = Math.min(100, Math.log10(d.出库_LB + 1) * 10); // 使用对数比例计算宽度
                                return `<div style="display: flex; align-items: center;">
                        <div style="width: ${barWidth}px; height: 20px; background-color: #26b510;"></div>
                        <div style="margin-left: 5px;">${d.出库_LB}</div>
                    </div>`;
                            }, align: 'center' },
                    ]
                ],
                done: function() {
                    // 设置toolbar的颜色为白色
                    var toolbar = document.querySelector('.layui-table-tool');
                    if (toolbar) {
                        toolbar.style.backgroundColor = 'white';
                    }
                    var tableView = document.querySelector('.layui-table-view');
                    if (tableView) {
                        tableView.style.borderRadius = '50px'; // 调整圆角的半径
                        tableView.style.overflow = 'hidden'; // 隐藏溢出内容
                        tableView.style.opacity = '0.8';
                        tableView.style.marginTop = '-20px';
                    }
                }
            });
        }

        layui.use(['form', 'laydate', 'table'], function() {
            var form = layui.form;  // 添加这行
            var laydate = layui.laydate;
            var table = layui.table;
            tableInstance = table;  // 将table对象赋值给全局变量
            // 初始化日期选择器
            laydate.render({
                elem: '#startDatePicker'
            });
            laydate.render({
                elem: '#endDatePicker'
            });
            laydate.render({
                elem: '#date'
                , range: true,
                rangeLinked: true,
                done: function(value, date, endDate) {
                    loadReport();
                }
            });
        });
    </script>
</body>
</html>