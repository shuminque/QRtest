<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>扫描二维码</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/css/qr/saoma1-styles.css" media="all">
    <link rel="stylesheet" href="/static/lib/layui-v2.8.17/css/layui.css" media="all">
    <link rel="stylesheet" href="/static/css/http_cdn.jsdelivr.net_npm_bootstrap@5.1.0_dist_css_bootstrap.css">
    <script type="text/javascript" src="/static/js/http_unpkg.com_html5-qrcode.js" charset="utf-8"></script>
    <script type="text/javascript" src="/static/js/jquery-2.1.0.js" charset="utf-8"></script>
    <script type="text/javascript" src="/static/js/jquery.qrcode.js" charset="utf-8"></script>
    <script src="/static/js/http_cdnjs.cloudflare.com_ajax_libs_bootstrap-3-typeahead_4.0.2_bootstrap3-typeahead.js"></script>
</head>
<style>
    @media print {
        body * {
            display: none;
        }
        #printContainer, #printContainer * {
            display: block;
            visibility: visible;
        }
        .layui-input-block, #updateCountButton {
            display: none;
        }
    }
    /* Layer 弹出框标题样式 */
    .layui-layer-title {
        text-align: center; /* 标题居中 */
        font-size: 22px; /* 增大字体大小 */
    }
    /* 调整按钮容器的样式，使按钮居中 */
    .layui-layer-btn {
        text-align: center;
    }
    /* Layer 弹出框按钮样式 */
    .layui-layer-btn .layui-layer-btn0, .layui-layer-btn .layui-layer-btn1 {
        width: 40%;
        height: 20%;
        font-size: 30px; /* 增大按钮字体大小 */
    }
    /* 在屏幕上默认不显示图标 */
    .icon-container-for-print {
        display: none;
    }
    /* 在打印时显示图标 */
    @media print {
        .icon-container-for-print {
            display: block;
        }
    }
    .your-icon-class {
        width: 100px;
        height: 100px;
        display: block;
        margin: 150px 0px -35px -60px;
        padding: 0 0 0 0;
        transform: rotate(90deg);
    }
    button.layui-btn {
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 22px;
        min-height: 69px;
        min-width: 41%;
        cursor: pointer;
    }
    a.dropdown-item {
        font-size: 30px;
    }

</style>
<body>
<div>
    <div>
        <input type="text" id="boxTextInput" placeholder="请输入箱号" class="layui-input">
    </div>
    <div class="button-container">
        <div class="button-row">
            <button class="layui-btn" onclick="preGenerateQRCodeByBoxText()">生成整箱二维码</button>
            <button class="layui-btn" onclick="preGenerateQRCodeByBoxTextForZero()">生成零箱二维码</button>
        </div>
        <div class="button-row">
            <button class="layui-btn" onclick="printQRCode()">打印二维码</button>
        </div>

<!--        <div class="button-row">-->
<!--            <input type="text" id="existingBoxTextInput" placeholder="请输入现有的boxText" class="layui-input">-->
<!--            <input type="text" id="existingBoxNumberInput" placeholder="请输入现有的boxNumber" class="layui-input">-->
<!--            <button class="layui-btn" onclick="generateExistingQRCode()">生成现有二维码</button>-->
<!--        </div>-->

    </div>
    <!-- 预生成信息的模态框 -->
    <div id="preGenerateModal" style="display:none;">
        <p>即将生成的 Number号: <span id="previewBoxNumber"></span></p>
        <p>数量: <input type="number" id="editQuantity" readonly /></p> <!-- 替换为输入框 -->
        <button onclick="confirmGenerateQRCode()">确认</button>
        <button onclick="cancelGenerateQRCode()">取消</button>
    </div>
    <div id="preGenerateModalForZero" style="display:none;">
        <p>即将生成的 Number号: <span id="previewBoxNumberForZero"></span></p>
        <p>数量: <input type="number" id="editQuantityForZero" /></p>
        <button onclick="confirmGenerateQRCodeForZero()">确认</button>
        <button onclick="cancelGenerateQRCodeForZero()">取消</button>
    </div>
</div>
<!--<button onclick="generateQRCode()">生成全部二维码</button>-->
<div class="button-container">
    <div class="button-row">
        <button class="inout" onclick="showModal('stockIn')">入库</button>
        <button class="inout" onclick="showModal('stockOut')">出库</button>
    </div>
    <div class="button-row">
        <button class="inout" onclick="showModal('return')">返库</button>
        <button class="inout" onclick="showModal('panKu')">盘库</button>
    </div>
    <div class="button-row">
        <button class="inout" onclick="showModal('transferIn')">转入</button>
        <button class="inout" onclick="showModal('transferOut')">转出</button>
    </div>
</div>
<!-- 模态框的内容，放在页面的某个位置 -->
<div id="scanModalContent" style="display: none;">
    <div style="text-align: center; margin-top: 20px;">
<!--        <button class="layui-btn layui-btn-normal" onclick="processScannedData()">确认</button>-->
        <button class="layui-btn layui-btn-normal" onclick="closeModal()">取消</button>
    </div>
    <input type="text" id="modalScanInput" placeholder="扫描数据" class="layui-input">
</div>

<div id="scanner-container" style="display:none;">
    <h2>扫描二维码</h2>
    <div id="qr-reader" style="width:500px"></div>
</div>
<!--<div class="button-row">-->
<!--    &lt;!&ndash; 使用window.location.href进行页面跳转 &ndash;&gt;-->
<!--    <button class="inout" onclick="window.location.href='/Inquire-all'">查看记录</button>-->
<!--</div>-->
<div class="button-row">
    <div class="layui-form-item layui-row">
        <div class="layui-col-xs8">
            <div class="layui-input-block" style="margin-left: 10px;" >
                <input type="text" name="date" id="datePicker" class="layui-input" placeholder="请选择日期"
                       style="margin-bottom: 0;font-size: 25px">
            </div>
        </div>
        <div class="layui-col-xs2" style="padding-left: 10px;">
            <button id="updateCountButton" class="layui-btn " style="min-height: 60px;">更新</button> <!-- 更新按钮 -->
        </div>
    </div>
</div>
<div class="button-row" style="font-size: 28px">
    入库箱数：<span id="stockInCount">0</span>箱
</div>
<div class="button-row" style="font-size: 28px">
    出库箱数：<span id="stockOutCount">0</span>箱
</div>
<!--<h3 style="text-align: center">二维码</h3>-->
<button id="regenerateButton" onclick="regenerateQRCode()" style="display: none;">修改数量</button>
<div id="printContainer">
    <div id="qrcodeContainer">
        <div id="qrcode"></div>
    </div>
    <div id="printSection">
        <div class="info-container"></div>
    </div>
</div>
<!-- 隐藏的确认模态框内容 -->
<div id="confirmModal" style="display: none;">
<!--    <p id="confirmModalText">请输入新的数量：</p>-->
    <input type="number" id="confirmQuantityInput" class="layui-input">
</div>

<div id="operation-result" style="display:none;"></div>
<script src="/static/lib/layui-v2.8.17/layui.js" charset="utf-8"></script>
<script>
    var currentOperation = null;
    var currentOperationType = ''; // 全局变量，存储当前操作类型
    var html5QrcodeScanner;var userReviewGroupId;var userAuthority;
    var userDepositoryId;var userDepository;var depositoryId;var defaultQuantity;var preGenerateData; // 用于存储即将生成的数据
    $(document).ready(function() {
        getUserDepository(); // 假设这是获取用户仓库信息的函数
        // 初始化移动端二维码输入框的自动完成功能
        $('#boxTextInput').typeahead({
            source: function(query, process) {
                return $.ajax({
                    url: '/bearings/search', // 确保这个URL是处理搜索请求的后端接口
                    type: 'GET',
                    data: { query: query, depository: userDepository }, // userDepository应该是当前用户的仓库信息
                    dataType: 'json',
                    success: function(data) {
                        console.log(data)
                        return process(data);
                    }
                });
            },
            minLength: 1, // 最小触发自动完成的字符数
            autoSelect: true // 自动选择第一个匹配项
        });
    });

    function getUserDepository() {
        $.ajax({
            url: '/get_user_depository',
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                console.log(data);
                userDepositoryId = data.depositoryId;
                userAuthority = data.authority;
                userReviewGroupId = data.review_group_id;
                if (userDepositoryId ===1){
                    userDepository='SAB';
                    depositoryId=1;
                } else if (userDepositoryId===2){
                    userDepository='ZAB';
                    depositoryId=2;
                }else{
                    userDepository="ALL";
                    depositoryId=0;
                }
            },
            error: function() {
                // 处理错误，例如显示一个消息
                layer.msg('无法获取用户的厂区信息');
            }
        });
    }
            // 使用Layui的日期选择器
    layui.use(['laydate', 'layer'], function() {
        var laydate = layui.laydate;
        var layer = layui.layer; // 假设用layer来显示错误信息

        // 初始化日期选择器
        laydate.render({
            elem: '#datePicker', // 绑定元素
            value: new Date(), // 默认值为今天
            done: function(value, date, endDate) {
                // 用户选择日期后立即更新库存数量
                updateCounts(value);
            }
        });

        // 更新按钮点击事件
        $('#updateCountButton').click(function() {
            var selectedDate = $('#datePicker').val();
            updateCounts(selectedDate);
        });

        // 根据选定的日期更新库存数量
        function updateCounts(selectedDate) {
            if (selectedDate) {
                // 确保在此之前已经通过getUserDepository()设置了userDepository
                $.ajax({
                    url: '/bearingRecords/countsByDateAndDepository',
                    type: 'GET',
                    data: {
                        date: selectedDate,
                        depository: userDepository // 这个变量必须事先正确设置
                    },
                    success: function(response) {
                        // 用响应的数据更新页面
                        $('#stockInCount').text(response.stockInCount || 0).hide().show();
                        $('#stockOutCount').text(response.stockOutCount || 0).hide().show();
                    },
                    error: function(xhr, status, error) {
                        console.error("请求库存数据失败: ", error);
                        layer.alert('获取数据失败，请稍后重试');
                    }
                });
            }
        }
    });
    function adjustPrintFontSize(boxText) {
        var length = boxText.length;
        var fontSize;

        if (length <= 3) {
            fontSize = '180px';
        } else if (length <= 8) {
            fontSize = '140px';
        } else if (length >8 && length <10){
            fontSize = '100px';
        } else {
            fontSize = '60px';
        }

        // 应用字体大小到打印样式
        var styleSheet = document.createElement("style")
        styleSheet.type = "text/css"
        styleSheet.innerText = `
        @media print {
            .print-info-row p.box-text {
                font-size: ${fontSize};
            }
        }
    `;
        document.head.appendChild(styleSheet);
    }


    document.addEventListener("DOMContentLoaded", function() {
        html5QrcodeScanner = new Html5QrcodeScanner(
            "qr-reader", { fps: 60, qrbox: 400 });
        getUserDepository(); // 获取用户厂区信息
    });
    function generateExistingQRCode() {
        var existingBoxText = document.getElementById("existingBoxTextInput").value;
        var existingBoxNumber = document.getElementById("existingBoxNumberInput").value;
        var existingDepositoryId = depositoryId;
        if (!existingBoxText || !existingBoxNumber) {
            alert("请输入现有的boxText和boxNumber");
            return;
        }
        // 向后端请求获取与现有boxText和boxNumber相关的数据
        fetch('/bearings/' + existingBoxText + '/' + existingBoxNumber + '/' + existingDepositoryId)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // 生成二维码
                var qrCodeElement = document.getElementById("qrcode");
                // 获取当前日期
                var currentDate = new Date();
                var year = currentDate.getFullYear(); // 年份
                var month = currentDate.getMonth() + 1; // 月份，getMonth() 返回的月份是从0开始计数的
                var day = currentDate.getDate(); // 日期
                var formattedMonth = month < 10 ? '0' + month : month;
                var formattedDay = day < 10 ? '0' + day : day;
                var currentTime = `${year}-${formattedMonth}-${formattedDay}`;
                qrCodeElement.innerHTML = ""; // 清除之前的二维码
                var newData = {
                    CTM: data.customer,
                    MDL: data.model,
                    boxText: data.boxText,
                    boxNumber: data.boxNumber,
                    iter: data.iter,
                    OIR: data.outerInnerRing,
                    quantity: data.quantity,
                    steelType: data.steelType,
                    steelGrade: data.steelGrade,
                    SL: data.storageLocation,
                    depository: data.depository,
                    time: currentTime // 添加时间戳
                };
                // var qrData = JSON.stringify(newData);
                var qrData = Object.values(newData).join('|');
                $('<div></div>').qrcode({
                    text: qrData,
                    render: 'canvas',
                    width: 200,
                    height: 200,
                    correctLevel: 3,
                }).appendTo(qrCodeElement);
                // 显示信息和元素
                updateInfoAndDisplayElements(data);
            })
            .catch(error => {
                console.error('生成现有二维码时发生错误：', error);
            });
    }
    // 显示信息和元素的共用函数
    function updateInfoAndDisplayElements(data) {
        var infoHtml = `
        <div class="info-row">
            <p><span>${data.boxText}-${data.boxNumber}</span></p>
        </div>
    `;
        var infoContainer = document.querySelector("#printSection .info-container");
        infoContainer.innerHTML = infoHtml;

        document.getElementById('qrcodeContainer').style.display = 'block';
        document.getElementById('printSection').style.display = 'block';
    }
    // 当用户点击“生成二维码”时执行
    function preGenerateQRCodeByBoxText() {
        var boxText = document.getElementById("boxTextInput").value;
        if (!boxText) {
            alert("请输入箱号");
            return;
        }
        var url = '/bearings/preGenerate/' + boxText + '/' + depositoryId;
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // 在存储预生成的数据之前，添加 boxText
                preGenerateData = {
                    ...data,
                    boxText: boxText, // 添加 boxText
                    depositoryId: depositoryId // 添加 depositoryId
                };
                defaultQuantity = data.quantity; // 将获取到的默认数量赋值给全局变量
                document.getElementById('previewBoxNumber').textContent = data.boxNumber;
                document.getElementById('editQuantity').value = data.quantity; // 设置输入框的初始值
                document.getElementById('editQuantity').setAttribute('data-initial-value', data.quantity);
                document.getElementById('preGenerateModal').style.display = 'block';
            })
            .catch(error => {
                console.error('预生成二维码时发生错误：', error);
                layer.alert("请输入正确的箱号");
            });
    }
    function preGenerateQRCodeByBoxTextForZero() {
        var boxText = document.getElementById("boxTextInput").value;
        if (!boxText) {
            alert("请输入箱号");
            return;
        }
        var url = '/bearings/zero/preGenerate/' + boxText + '/' + depositoryId;
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // 在存储预生成的数据之前，添加 boxText
                preGenerateData = {
                    ...data,
                    boxText: boxText, // 添加 boxText
                    depositoryId: depositoryId // 添加 depositoryId
                };
                defaultQuantity = data.quantity; // 将获取到的默认数量赋值给全局变量
                document.getElementById('previewBoxNumberForZero').textContent = data.boxNumber;
                document.getElementById('editQuantityForZero').value = data.quantity; // 设置输入框的初始值
                document.getElementById('editQuantityForZero').setAttribute('data-initial-value', data.quantity);
                document.getElementById('preGenerateModalForZero').style.display = 'block';
            })
            .catch(error => {
                console.error('预生成二维码时发生错误：', error);
                layer.alert("请输入正确的箱号");
            });
    }
    // 当用户点击“确认”按钮时执行
    function confirmGenerateQRCode() {
        console.log(preGenerateData);
        preGenerateData.quantity = document.getElementById('editQuantity').value;
        // 确保发送到后端的数据包括厂区ID
        fetch('/bearings/' + preGenerateData.boxText+'/' + depositoryId, {
            method: 'POST',
            body: JSON.stringify(preGenerateData),
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // 生成二维码
                var qrCodeElement = document.getElementById("qrcode");
                // 获取当前日期
                var currentDate = new Date();
                var year = currentDate.getFullYear(); // 年份
                var month = currentDate.getMonth() + 1; // 月份，getMonth() 返回的月份是从0开始计数的
                var day = currentDate.getDate(); // 日期
                var formattedMonth = month < 10 ? '0' + month : month;
                var formattedDay = day < 10 ? '0' + day : day;
                var currentTime = `${year}-${formattedMonth}-${formattedDay}`;
                qrCodeElement.innerHTML = ""; // 清除之前的二维码
                var newData = {
                    CTM: data.customer,
                    MDL: data.model,
                    boxText: data.boxText,
                    boxNumber: data.boxNumber,
                    iter: data.iter,
                    OIR: data.outerInnerRing,
                    quantity: data.quantity,
                    steelType: data.steelType,
                    steelGrade: data.steelGrade,
                    SL: data.storageLocation,
                    depository: data.depository,
                    time: currentTime // 添加时间戳
                };
                // var qrData = JSON.stringify(newData);
                var qrData = Object.values(newData).join('|');
                $('<div></div>').qrcode({
                    text: qrData,
                    render: 'canvas',
                    width: 200,
                    height: 200,
                    correctLevel: 3,
                }).appendTo(qrCodeElement);

                // 检查数量是否改变
                var currentQuantity = parseInt(document.getElementById('editQuantity').value);
                var isQuantityChanged = defaultQuantity !== currentQuantity;

                // 根据数量是否改变，决定是否显示图标
                var iconHtml = isQuantityChanged ? `
                     <div class="icon-container-for-print">
                        <img src="/static/images/iic.png" alt="Icon" class="your-icon-class">
                    </div>
                ` : '';
                        // 显示信息，包括或不包括图标
                var infoHtml = `
                    <div class="info-row print-info-row">
                        <p class="box-text"><span>${data.boxText}</span></p>
                    </div>
                    ${iconHtml}
                    <div class="info-row print-info-row">
                        <p class="box-number"><span>${data.boxNumber}</span></p>
                    </div>
                `;
                var infoContainer = document.querySelector("#printSection .info-container");
                infoContainer.innerHTML = infoHtml;
                adjustPrintFontSize(data.boxText);
                // 显示元素
                document.getElementById('qrcodeContainer').style.display = 'block';
                document.getElementById('printSection').style.display = 'block';
                document.getElementById('preGenerateModal').style.display = 'none';
                // document.getElementById('regenerateButton').style.display = 'block';
            })
                .catch(error => {
                console.error('生成二维码时发生错误：', error);
            });
    }
    function confirmGenerateQRCodeForZero() {
        console.log(preGenerateData);
        preGenerateData.quantity = document.getElementById('editQuantityForZero').value;
        // 确保发送到后端的数据包括厂区ID
        fetch('/bearings/zero/' + preGenerateData.boxText+'/' + depositoryId, {
            method: 'POST',
            body: JSON.stringify(preGenerateData),
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // 生成二维码
                var qrCodeElement = document.getElementById("qrcode");
                var currentDate = new Date();
                var year = currentDate.getFullYear(); // 年份
                var month = currentDate.getMonth() + 1; // 月份，getMonth() 返回的月份是从0开始计数的
                var day = currentDate.getDate(); // 日期
                var formattedMonth = month < 10 ? '0' + month : month;
                var formattedDay = day < 10 ? '0' + day : day;
                var currentTime = `${year}-${formattedMonth}-${formattedDay}`;
                qrCodeElement.innerHTML = ""; // 清除之前的二维码
                var newData = {
                    CTM: data.customer,
                    MDL: data.model,
                    boxText: data.boxText,
                    boxNumber: data.boxNumber,
                    iter: data.iter,
                    OIR: data.outerInnerRing,
                    quantity: data.quantity,
                    steelType: data.steelType,
                    steelGrade: data.steelGrade,
                    SL: data.storageLocation,
                    depository: data.depository,
                    time: currentTime
                };
                // var qrData = JSON.stringify(newData);
                var qrData = Object.values(newData).join('|');
                $('<div></div>').qrcode({
                    text: qrData,
                    render: 'canvas',
                    width: 200,
                    height: 200,
                    correctLevel: 3,
                }).appendTo(qrCodeElement);

                // 检查数量是否改变
                var currentQuantity = parseInt(document.getElementById('editQuantityForZero').value);
                var isQuantityChanged = defaultQuantity !== currentQuantity;

                // 根据数量是否改变，决定是否显示图标
                var iconHtml = isQuantityChanged ? `
                     <div class="icon-container-for-print">
                        <img src="/static/images/iic.png" alt="Icon" class="your-icon-class">
                    </div>
                ` : '';
                // 显示信息，包括或不包括图标
                var infoHtml = `
                    <div class="info-row print-info-row">
                        <p class="box-text"><span>${data.boxText}</span></p>
                    </div>
                    ${iconHtml}
                    <div class="info-row print-info-row">
                        <p class="box-number"><span>${data.boxNumber}</span></p>
                    </div>
                `;
                var infoContainer = document.querySelector("#printSection .info-container");
                infoContainer.innerHTML = infoHtml;
                adjustPrintFontSize(data.boxText);
                // 显示元素
                document.getElementById('qrcodeContainer').style.display = 'block';
                document.getElementById('printSection').style.display = 'block';
                document.getElementById('preGenerateModalForZero').style.display = 'none';
                document.getElementById('regenerateButton').style.display = 'block';

            })
            .catch(error => {
                console.error('生成二维码时发生错误：', error);
            });
    }
    // 当用户点击“取消”按钮时执行
    function cancelGenerateQRCode() {
        preGenerateData = null;
        document.getElementById('preGenerateModal').style.display = 'none';
        document.getElementById('regenerateButton').style.display = 'none';
    }
    function cancelGenerateQRCodeForZero() {
        document.getElementById('preGenerateModalForZero').style.display = 'none';
        document.getElementById('regenerateButton').style.display = 'none';
    }
    function regenerateQRCode() {
        var newQuantity = prompt("请输入新的数量:", "");
        if (newQuantity != null && !isNaN(newQuantity) && newQuantity > 0) {
            var isQuantityChanged = parseInt(newQuantity) !== defaultQuantity;
            if (preGenerateData.boxNumber > 999) {
                updateQRCodeQuantityForZero(parseInt(newQuantity), isQuantityChanged);
                console.log("零箱零箱零箱零箱")
            } else {
                updateQRCodeQuantity(parseInt(newQuantity), isQuantityChanged);
            }
        } else {
            alert("请输入有效的数量");
        }
    }
    function updateQRCodeQuantityForZero(newQuantity, isQuantityChanged) {
        fetch('/bearings/' + preGenerateData.boxText + '/' + preGenerateData.depositoryId + '/regenerateZero', {
            method: 'POST',
            body: JSON.stringify({ quantity: newQuantity, iter: preGenerateData.iter}),
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(updatedData => {
                // Use the updated data to regenerate QR code
                generateQRCode(updatedData, isQuantityChanged);
                updateProductQuantity(updatedData.boxText, updatedData.boxNumber, newQuantity, convertDepositoryIdToMath(updatedData.depository), updatedData.iter);

            })
            .catch(error => console.error('Error updating QR code:', error));
    }
    function updateQRCodeQuantity(newQuantity, isQuantityChanged) {
        fetch('/bearings/' + preGenerateData.boxText + '/' + preGenerateData.depositoryId + '/regenerate', {
            method: 'POST',
            body: JSON.stringify({ quantity: newQuantity, iter: preGenerateData.iter}),
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(updatedData => {
                // Use the updated data to regenerate QR code
                generateQRCode(updatedData, isQuantityChanged);
                updateProductQuantity(updatedData.boxText, updatedData.boxNumber, newQuantity, convertDepositoryIdToMath(updatedData.depository), updatedData.iter);

            })
            .catch(error => console.error('Error updating QR code:', error));
    }
    function generateQRCode(data, isQuantityChanged) {
        var qrCodeElement = document.getElementById("qrcode");
        var currentDate = new Date();
        var year = currentDate.getFullYear(); // 年份
        var month = currentDate.getMonth() + 1; // 月份，getMonth() 返回的月份是从0开始计数的
        var day = currentDate.getDate(); // 日期
        var formattedMonth = month < 10 ? '0' + month : month;
        var formattedDay = day < 10 ? '0' + day : day;
        var currentTime = `${year}-${formattedMonth}-${formattedDay}`;
        qrCodeElement.innerHTML = ""; // Clear existing QR code
        var newData = {
            CTM: data.customer,
            MDL: data.model,
            boxText: data.boxText,
            boxNumber: data.boxNumber,
            iter: data.iter,
            OIR: data.outerInnerRing,
            quantity: data.quantity,
            steelType: data.steelType,
            steelGrade: data.steelGrade,
            SL: data.storageLocation,
            depository: data.depository,
            time:currentTime
        };
        // var qrData = JSON.stringify(newData);
        var qrData = Object.values(newData).join('|');
        $('<div></div>').qrcode({
            text: qrData,
            render: 'canvas',
            width: 200,
            height: 200,
            correctLevel: 3,
        }).appendTo(qrCodeElement);
            // 根据 isQuantityChanged 决定是否添加图标
            var iconHtml = isQuantityChanged ? `
            <div class="icon-container-for-print">
                <img src="/static/images/iic.png" alt="Icon" class="your-icon-class">
            </div>
        ` : '';

            // 显示信息，包括或不包括图标
            var infoHtml = `
            <div class="info-row print-info-row">
                <p class="box-text"><span>${data.boxText}</span></p>
            </div>
            ${iconHtml}
            <div class="info-row print-info-row">
                <p class="box-number"><span>${data.boxNumber}</span></p>
            </div>
        `;
            var infoContainer = document.querySelector("#printSection .info-container");
            infoContainer.innerHTML = infoHtml;
            adjustPrintFontSize(data.boxText);
    }
    var isListenerAdded = false;
    function showModal(operation) {
        currentOperation = operation;
        openModal();
        var modalScanInput = document.getElementById('modalScanInput');
        modalScanInput.focus(); // 自动聚焦到输入框
        // 只有在监听器尚未添加的情况下才添加新的监听器
        if (!isListenerAdded) {
            modalScanInput.addEventListener('keydown', handleEnterKey);
            isListenerAdded = true;
        }
    }
    function handleEnterKey(event) {
        console.log("Enter key pressed");
        if (event.key === 'Enter') {
            // 模拟点击确认按钮
            processScannedData();
        }
    }
    function openModal() {
        layer.open({
            type: 1, // 弹出层类型，1 表示页面层
            title: '扫描二维码', // 标题
            content: $('#scanModalContent'), // 弹出层内容
            shadeClose: true, // 设置点击遮罩层关闭弹出层
            area: ['80%', '40%'], // 设置弹出层大小
            // 弹出层关闭时的回调
            cancel: function() {
                document.getElementById('modalScanInput').value = ''; // 清空输入框
            },
            // 弹出层销毁时的回调
            end: function() {
                document.getElementById('modalScanInput').value = ''; // 清空输入框
            }
        });
    }
    function processScannedData() {
        var scannedData = document.getElementById('modalScanInput').value;
        console.log(scannedData);
        var depositoryQRid;
        try {
            var correctedJson = scannedData.replace(/(\w+:)|(\w+ :)/g, function (matchedString) {
                return '"' + matchedString.substring(0, matchedString.length - 1) + '":';
            });
            console.log(correctedJson);
            // var data = JSON.parse(correctedJson);
            var values = scannedData.split('|');
            var data = {
                CTM: values[0],
                MDL: values[1],
                boxText: values[2],
                boxNumber: values[3],
                iter: values[4],
                OIR: values[5],
                quantity: values[6],
                steelType: values[7],
                steelGrade: values[8],
                SL: values[9],
                depository: values[10]
            };
            console.log(data);
            depositoryQRid = convertDepositoryIdToMath(data.depository);
            console.log(data.boxText);
            switch (currentOperation) {
                case 'stockIn':
                    stockIn(data, currentOperation, depositoryQRid);
                    break;
                case 'stockOut':
                    if(userDepository === 'SAB' && data.depository !== 'SAB') {
                        data.boxText = data.boxText.substring(1); // 如果目标是SAB且来源不是SAB，去掉箱号开头的'Z'
                    } else if (userDepository === 'ZAB' && data.depository !== 'ZAB'){
                        data.boxText = "Z" + data.boxText; // 如果目标是ZAB且来源不是ZAB，加上箱号开头的'Z'
                    }
                    stockOut(data.boxText, data.boxNumber, data.quantity, currentOperation, depositoryQRid, data.iter);
                    break;
                case 'transferIn':
                    if(userDepository === 'SAB' && data.depository !== 'SAB') {
                        data.boxText = data.boxText.substring(1); // 如果目标是SAB且来源不是SAB，去掉箱号开头的'Z'
                    } else if (userDepository === 'ZAB' && data.depository !== 'ZAB'){
                        data.boxText = "Z" + data.boxText; // 如果目标是ZAB且来源不是ZAB，加上箱号开头的'Z'
                    }
                    stockIn(data, currentOperation, depositoryQRid);
                    break;
                case 'transferOut':
                    stockOut(data.boxText, data.boxNumber, data.quantity, currentOperation, depositoryQRid, data.iter);
                    break;
                case 'return':
                    stockOut(data.boxText, data.boxNumber, data.quantity, currentOperation, depositoryQRid, data.iter);
                    break;
                case 'panKu':
                    fetchPanKuInfo(data.boxText, data.boxNumber, data.depository, data.quantity,); // 使用二维码内的depositoryId
                    break;
            }
            // 处理完数据后，清空输入框并重新聚焦，准备下一次扫描
            document.getElementById('modalScanInput').value = '';
            document.getElementById('modalScanInput').focus();
            console.log("Input refocused");
            // 不关闭模态框，注释掉或移除下面这行代码
            // layer.closeAll();
        } catch (error) {
            console.error('解析扫描数据时出错: ', error);
            // 如果发生错误，可以选择是否关闭模态框或者只是显示错误信息
            // layer.closeAll();
            // 显示错误信息的逻辑
        }
    }
    function closeModal() {
        // 清空输入框
        document.getElementById('modalScanInput').value = '';
        // 移除事件监听器
        var modalScanInput = document.getElementById('modalScanInput');
        if (isListenerAdded) {
            modalScanInput.removeEventListener('keydown', handleEnterKey);
            isListenerAdded = false;
        }
        resetScanner(true); // 无论成功或失败，重置扫描器
        // 关闭当前打开的层（假设它是最新打开的）
         layer.closeAll();
    }
    function convertDepositoryIdToText(depositoryId) {
        switch (depositoryId) {
            case 1: return "SAB";
            case 2: return "ZAB";
            default: return "Unknown";
        }
    }
    function convertDepositoryIdToMath(depositoryId) {
        switch (depositoryId) {
            case "SAB": return 1;
            case "ZAB": return 2;
            default: return 0;
        }
    }
    function addBearingRecord(transactionType, boxText, boxNumber, quantity, depositoryId, iter) {
        var depositoryText = convertDepositoryIdToText(depositoryId);
        var recordDto = {
            transactionType: transactionType,
            boxText: boxText,
            boxNumber: boxNumber,
            quantity: quantity,
            depository: depositoryText, // 使用 "depository" 作为字段名
            iter: iter
            // ... 其他必要字段 ...
        };
        return fetch('/bearingRecords', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(recordDto)
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('记录库操作失败');
                }
            });
    }
    // 入库操作
    function stockIn(data, operationType, depositoryId) {
        var depositoryName = convertDepositoryIdToText(depositoryId);
        var originalQuantity=data.quantity;
        fetch(`/bearingRecords/checkSpecialRecord/${data.boxText}/${data.boxNumber}/${depositoryName}/${originalQuantity}/${data.iter}`)
            .then(response => response.json())
            .then(outcome => {
                if (!outcome.hasSpecial) {
                    return proceedStockIn(data.boxText, data.boxNumber, originalQuantity, operationType, depositoryId, data.iter);
                }
                // 设置提示文本
                // $('#confirmModalText').text('：');
                // 弹出自定义的确认框
                layer.open({
                    type: 1,
                    title: '<div style="line-height: 1.1em; height: auto; ">该箱号产品多次入库<br>需要确认数量，数量有变化<br>重新打印二维码</div>',
                    content: $('#confirmModal'),
                    area: ['80%', '40%'],
                    btn: ['确认', '取消'],
                    success: function(layero, index) {
                        layer.style(index, {
                            top: 0,
                        });
                        layero.find('.layui-layer-title').css('height', '80px');
                        layero.find('.layui-layer-content').css('height', '90px');
                            $('#confirmQuantityInput').val(originalQuantity); // 设置默认值
                    },
                    yes: function(index, layero) {
                        const newQuantity = parseInt($('#confirmQuantityInput').val(), 10);
                        if (isNaN(newQuantity) || newQuantity <= 0) {
                            layer.msg('请输入有效数量');
                            return;
                        }
                        layer.close(index); // 关闭确认框
                        handleQuantityUpdate(data, newQuantity, originalQuantity, operationType, depositoryId, depositoryName);
                    },
                    btn2: function(index, layero) {
                        layer.close(index); // 关闭确认框
                    }
                });
            })
            .catch(error => {
                console.error('检查特殊记录时出错:', error);
            });
    }

    function handleQuantityUpdate(data, newQuantity, originalQuantity, operationType, depositoryId, depositoryName) {
        var isQuantityChanged = newQuantity !== parseInt(originalQuantity);
        var isOriginallyWholeBox = data.boxNumber.length === 3; // 整箱的判断条件

        if (isQuantityChanged && isOriginallyWholeBox) {
            // 如果数量变化且原来是整箱，调用API生成新的零箱
            fetch('/bearings/zero/' + data.boxText + '/' + depositoryId, {
                body: JSON.stringify({
                    ...data,
                    quantity: newQuantity.toString()
                }),
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(newZeroBoxData => {
                    console.log("响应数据:", newZeroBoxData); // 确认响应数据结构
                    if (newZeroBoxData.boxNumber === undefined) {
                        console.error("响应中缺少boxNumber字段");
                        // 处理错误情况，例如设置默认值或返回错误
                        return;
                    }
                    // 使用新的零箱信息进行入库操作
                    console.log("更新后的数据:", data);
                    data.boxNumber = newZeroBoxData.boxNumber; // 更新箱号为新的零箱号
                    proceedStockIn(data.boxText, data.boxNumber, newQuantity, operationType, depositoryId,newZeroBoxData.iter)
                        .then(() => {
                            // 可能还需要更新二维码等后续操作
                            updateQRCodeWithData(data, newQuantity, depositoryName, true);
                        });
                })
                    .catch(error => {
                    console.error('生成新零箱或入库操作失败:', error);
                    // 这里可以处理错误，比如显示提示信息
                });
        } else if (isQuantityChanged) {
            // 数量发生变化时更新数量和二维码，并显示图标
            updateProductQuantity(data.boxText, data.boxNumber, newQuantity, depositoryId, data.iter)
                .then(() => proceedStockIn(data.boxText, data.boxNumber, newQuantity, operationType, depositoryId, data.iter))
                .then(() => {
                    console.log(newQuantity);
                    console.log(originalQuantity);
                    console.log(defaultQuantity);
                    var isQuantityChanged = parseInt(newQuantity) !== defaultQuantity; // 检查数量是否更改
                    updateQRCodeWithData(data, newQuantity, depositoryName, isQuantityChanged); // 根据是否更改显示图标
                })
                .catch(error => {
                    console.error('更新数量或入库操作失败，正在尝试回滚:', error);
                    return updateProductQuantity(data.boxText, data.boxNumber, originalQuantity, depositoryId, data.iter)
                        .catch(rollbackError => {
                            console.error('回滚更新数量时出错:', rollbackError);
                        });
                });
        } else {
            // 数量未变化，直接执行入库操作
            proceedStockIn(data.boxText, data.boxNumber, originalQuantity, operationType, depositoryId, data.iter)
                .catch(error => console.error('入库操作失败:', error));
        }
    }


    function updateQRCodeWithData(data, quantity, depositoryName, isQuantityChanged) {
        // var qrData = JSON.stringify({boxText: boxText, boxNumber: boxNumber,
        //     quantity:  quantity, depository: depositoryName, iter: iter,
        // });
        var currentDate = new Date();
        var year = currentDate.getFullYear(); // 年份
        var month = currentDate.getMonth() + 1; // 月份，getMonth() 返回的月份是从0开始计数的
        var day = currentDate.getDate(); // 日期
        var formattedMonth = month < 10 ? '0' + month : month;
        var formattedDay = day < 10 ? '0' + day : day;
        var currentTime = `${year}-${formattedMonth}-${formattedDay}`;
        var qrData = [data.CTM,data.MDL,data.boxText, data.boxNumber,data.iter,data.OIR, quantity, data.steelType,
                      data.steelGrade,data.SL,depositoryName,currentTime].join('|');
        var qrCodeElement = document.getElementById("qrcode");
        qrCodeElement.innerHTML = ""; // 清除旧的二维码
        $('<div></div>').qrcode({
            text: qrData,
            render: 'canvas',
            width: 200,
            height: 200,
            correctLevel: 3,
        }).appendTo(qrCodeElement);
        var iconHtml = isQuantityChanged ? `
            <div class="icon-container-for-print">
                <img src="/static/images/iic.png" alt="Icon" class="your-icon-class" id="iconImage">
            </div>
        ` : '';

        // 显示信息，包括或不包括图标
        var infoHtml = `
                        <div class="info-row print-info-row">
                            <p class="box-text"><span>${data.boxText}</span></p>
                        </div>
                        ${iconHtml}
                        <div class="info-row print-info-row">
                            <p class="box-number"><span>${data.boxNumber}</span></p>
                        </div>
                    `;
        var infoContainer = document.querySelector("#printSection .info-container");
        infoContainer.innerHTML = infoHtml;
        adjustPrintFontSize(data.boxText);
        // 如果图标存在，等待图标加载完成后再打印
        if (isQuantityChanged) {
            var iconImage = document.getElementById("iconImage");
            iconImage.onload = function() {
                window.print();
            };
        } else {
            window.print();
        }
    }

    function updateProductQuantity(boxText, boxNumber, newQuantity, depositoryId, iter) {
        return fetch('/productIds/updateQuantity', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                boxText: boxText,
                boxNumber: boxNumber,
                quantity: newQuantity,
                depositoryId: depositoryId,
                iter: iter
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('更新失败，状态码：' + response.status);
                }
                if (response.headers.get("Content-Type")?.includes("application/json")) {
                    return response.json();
                } else {
                    // 响应为空时，直接返回成功的结果
                    return { message: '更新成功' };
                }
            });
    }
    function proceedStockIn(boxText, boxNumber, quantity, operationType, depositoryId, iter) {
        const operationTypeChinese = getOperationTypeInChinese(operationType);
        var inventoryDto = {
            boxText: boxText,
            boxNumber: boxNumber,
            quantityInStock: quantity,
            operationType: operationTypeChinese,
            depositoryId: depositoryId,
            iter: iter
        };

        return fetch('/bearingInventory/stockIn', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(inventoryDto),
        })
            .then(response => {
                if (!response.ok) {
                    // 处理错误情况
                    return response.json().then(err => {
                        console.log(err);
                        // 根据错误信息显示不同的弹出消息
                        let errorMsg = "入库失败";
                        if (err.message === "产品已入库，不能再次入库") {
                            layer.alert("该箱号产品重复入库，操作无效", {icon: 2});
                            errorMsg = "产品已入库，不能再次入库";
                        } else {
                            layer.alert(`错误: ` + err.message, {icon: 2});
                            errorMsg = err.message;
                        }
                        // 在任何失败的情况下都抛出错误
                        throw new Error(errorMsg);
                    });
                }
                return response.json();
            })
            .then(data => {
                layer.msg("入库成功",{icon: 6, time:1000});
                showResult(`${operationTypeChinese}成功: ` + JSON.stringify(data));
                return addBearingRecord(operationTypeChinese, boxText, boxNumber, quantity, depositoryId, iter);
            });
    }


    // 出库操作
    function stockOut(boxText, boxNumber, quantity, operationType, depositoryId, iter) {
        console.log("执行操作: ", operationType, boxText, boxNumber, quantity);
        const operationTypeChinese = getOperationTypeInChinese(operationType);
        var inventoryDto = {
            boxText: boxText,
            boxNumber: boxNumber,
            quantityInStock: quantity,
            operationType: operationTypeChinese,
            depositoryId: depositoryId,
            iter: iter
        };
        fetch('/bearingInventory/stockOut', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(inventoryDto),
        })
            .then(response => {
                if (!response.ok) {
                    // 处理错误情况
                    return response.json().then(err => {
                        console.log(err);
                        // 定制错误消息
                        if (err.message === "产品未入库，不能出库") {
                            layer.alert("仓库里无该箱号产品，操作无效", {icon: 2});
                        } else {
                            layer.alert(`库存数不足，此操作无效: ` + err.message, {icon: 2});
                        }
                        throw new Error(err.message);
                    });
                }
                return response.json();
            })
            .then(data => {
                // 显示操作结果
                layer.msg("出库成功",{icon: 6, time:1000});
                showResult(`${operationTypeChinese}成功: ` + JSON.stringify(data));
                return addBearingRecord(operationTypeChinese, boxText, boxNumber, quantity,depositoryId,iter);
            })
            .catch(error => {
                console.error(`${operationTypeChinese}失败:`, error);
            })
            .finally(() => {
                resetScanner(false);
            });
    }
    function openPanKu(data) {
        layer.open({
            type: 1,
            title: `在库盘点信息`,
            content: generatePanKuContent(data),
            shadeClose: true,
            area: ['80%', '35%'],
            cancel: function() {
                document.getElementById('modalScanInput').value = '';
            },
            end: function() {
                document.getElementById('modalScanInput').value = '';
            }
        });
    }
    function generatePanKuContent(data) {
        var isStockedContent = data.isStocked > 0 ? `有: ${data.isStocked} 箱，数量: ${data.quantity} 个` : `有: 0 箱，数量: 0 个`;
        var totalBoxesContent = data.totalBoxes > 0 ? `仓库内合计: ${data.totalBoxes} 箱，数量: ${data.quantityInStock} 个` : '无库存';
        var contentHTML = `
    <div style="padding: 10px;">
        <p style="margin-bottom: 10px;"><strong>型号:</strong> ${data.outerInnerRing} ${data.model}</p>
        <p style="margin-bottom: 10px;"><strong>箱号:</strong> ${data.boxText} ${data.boxNumber}</p>
        <p style="margin-bottom: 10px;"><strong>当前状态:</strong> ${isStockedContent}</p>
        <p><strong>仓库总览:</strong> ${totalBoxesContent}</p>
    </div>
    `;
        return contentHTML;
    }
    function fetchPanKuInfo(boxText, boxNumber, depositoryId) {
        var mathDepositoryId = convertDepositoryIdToMath(depositoryId);

        // 显示加载指示器
        var loadingIndex = layer.load(1, {shade: [0.5, '#fff']});
        console.log(boxText);
        console.log(boxNumber);
        console.log(depositoryId);

        fetch(`/bearingInventory/panKu/${boxText}/${boxNumber}/${mathDepositoryId}`)
            .then(response => {
                // 关闭加载指示器
                layer.close(loadingIndex);

                if (!response.ok) {
                    throw new Error('网络响应错误');
                }
                return response.json();
            })
            .then(data => {
                // 在这里处理和显示从盘库API获取到的数据
                console.log(data);
                openPanKu(data);
            })
            .catch(error => {
                // 关闭加载指示器
                layer.close(loadingIndex);
                // 显示用户友好的错误消息
                console.error('Error:', error);
                layer.alert('获取盘库信息失败，请稍后重试', {icon: 2});
            });
    }
    // 显示操作结果（入库或出库）
    function showResult(message) {
        var resultContainer = document.getElementById('operation-result');
        resultContainer.innerHTML = message + ' <button onclick="resetScanner()">关闭</button>';
        resultContainer.style.display = "block";
    }
    function resetScanner(shouldResetOperation = true) {
        document.getElementById("scanner-container").style.display = "none";
        if (shouldResetOperation) {
            currentOperation = null;
        }
        var resultContainer = document.getElementById('operation-result');
        resultContainer.style.display = "none";
        html5QrcodeScanner.clear(); // 清除扫描器的结果和状态
    }

    function printQRCode() {
        window.print();
    }
    function downloadQRCode() {
        var qrCodeCanvas = document.querySelector('#qrcode canvas');
        if (qrCodeCanvas) {
            var image = qrCodeCanvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
            var link = document.createElement('a');
            link.download = 'qrcode.png';
            link.href = image;
            link.click();
        } else {
            alert('请先生成二维码！');
        }
    }
    function getOperationTypeInChinese(operationType) {
        const operationTypeMap = {
            'stockIn': '入库',
            'stockOut': '出库',
            'transferIn': '转入',
            'transferOut': '转出',
            'return': '返库',
            'panKu': '盘库'
        };
        return operationTypeMap[operationType] || operationType;
    }
</script>
</body>
</html>
