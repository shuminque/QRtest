<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>扫描二维码</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="text/javascript" src="/static/js/http_unpkg.com_html5-qrcode.js" charset="utf-8"></script>
    <script type="text/javascript" src="/static/js/jquery-2.1.0.js" charset="utf-8"></script>
    <script type="text/javascript" src="/static/js/jquery.qrcode.js" charset="utf-8"></script>

</head>
<style>
    @media print {
        body * {
            display: none;  /* 隐藏页面上所有内容 */
        }
        #qrcode, #qrcode * {
            display: block; /* 只显示 #qrcode 内的内容 */
        }
        #qrcode {
            position: absolute;
            left: 0;
            top: 0;
        }
    }
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        padding: 20px;
        color: #333;
    }

    .layui-input, .layui-btn {
        margin-bottom: 10px;
    }

    #preGenerateModal {
        background-color: white;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
    }

    #qrcode {
        margin-top: 20px;
        padding: 10px;
        background-color: white;
        text-align: left;
        border: 1px solid #ddd;
    }

    button.layui-btn {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
    }

    button.layui-btn:hover {
        background-color: #0056b3;
    }

    #operation-result {
        margin-top: 20px;
    }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
    }
     .info-container {
         display: flex;
         flex-direction: column;
         flex-wrap: wrap;
         max-width: 400px; /* 调整宽度以适应您的设计 */
     }
    .info-item {
        flex-basis: 50%; /* 每个项目占据容器宽度的50% */
        box-sizing: border-box;
        padding: 4px; /* 减少这个值可以减小列之间的空间 */
        margin-right: 8px; /* 减少这个值可以减小列之间的空间 */
    }
    /* 确保最后一个项目不具有右边距 */
    .info-item:last-child {
        margin-right: 0;
    }
    .info-row {
        display: flex;
        justify-content: space-between; /* This will space out the <p> tags evenly */
    }
    .info-row p {
        margin: 0 0 0 0 ; /* Remove default paragraph margin */
        flex: 1; /* Each <p> element will take up equal space */
        padding: 0 10px; /* Add some padding */
    }
</style>

<body>
<div>

    <div>
        <input type="text" id="boxTextInput" placeholder="请输入" class="layui-input">
    </div>
    <div>
        <button class="layui-btn" onclick="preGenerateQRCodeByBoxText()">生成二维码</button>
        <button class="layui-btn" onclick="printQRCode()">打印二维码</button>
    </div>
    <!-- 预生成信息的模态框 -->
    <div id="preGenerateModal" style="display:none;">
        <p>即将生成的 Number号: <span id="previewBoxNumber"></span></p>
        <p>数量: <input type="number" id="editQuantity" /></p> <!-- 替换为输入框 -->
        <button onclick="confirmGenerateQRCode()">确认</button>
        <button onclick="cancelGenerateQRCode()">取消</button>
    </div>
</div>
<!--<button onclick="generateQRCode()">生成全部二维码</button>-->
<button onclick="prepareOperation('stockIn')">入库</button>
<button onclick="prepareOperation('stockOut')">出库</button>
<button onclick="prepareOperation('stockOut')">返库</button>
<button onclick="prepareOperation('stockIn')">转入</button>
<button onclick="prepareOperation('stockOut')">转出</button>
<div id="scanner-container" style="display:none;">
    <h2>扫描二维码</h2>
    <div id="qr-reader" style="width:500px"></div>
</div>
<h3>二维码:</h3>
<div id="qrcode">
</div>

<div id="operation-result" style="display:none;"></div>

<script>
    var currentOperation = null;
    var html5QrcodeScanner;

    document.addEventListener("DOMContentLoaded", function() {
        html5QrcodeScanner = new Html5QrcodeScanner(
            "qr-reader", { fps: 30, qrbox: 400 });
    });

    var preGenerateData; // 用于存储即将生成的数据
    // 当用户点击“生成二维码”时执行
    function preGenerateQRCodeByBoxText() {
        var boxText = document.getElementById("boxTextInput").value;
        if (!boxText) {
            alert("请输入box_text");
            return;
        }

        fetch('/bearings/preGenerate/' + boxText)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // 在存储预生成的数据之前，添加 boxText
                preGenerateData = {
                    ...data,
                    boxText: boxText // 添加 boxText
                };
                document.getElementById('previewBoxNumber').textContent = data.boxNumber;
                document.getElementById('editQuantity').value = data.quantity; // 设置输入框的初始值
                document.getElementById('preGenerateModal').style.display = 'block';
            })
            .catch(error => console.error('预生成二维码时发生错误：', error));
    }

    // 当用户点击“确认”按钮时执行
    function confirmGenerateQRCode() {
        console.log(preGenerateData);
        preGenerateData.quantity = document.getElementById('editQuantity').value;
        // 使用存储的数据调用原先的API端点保存数据并生成二维码
        fetch('/bearings/' + preGenerateData.boxText , {
            method: 'POST',
            body: JSON.stringify(preGenerateData),
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // 在这里生成二维码
                var qrCodeElement = document.getElementById("qrcode");

                // 清除之前的二维码和信息
                qrCodeElement.innerHTML = "";

                // 使用获取的数据生成二维码
                var qrData = JSON.stringify(data);

                // 创建二维码
                var qrContainer = $('<div></div>').css({
                    margin: '10px' // 添加外边距
                });
                qrContainer.qrcode({
                    text: qrData, // The data for the QR code
                    render: 'canvas',
                    width: 100,
                    height: 100
                });

                // Create the information HTML
                var infoHtml = `
                    <div class="info-container">
                        <div class="info-row">
                            <p>箱号:<span id="boxText">${data.boxText}</span></p>
                            <p>序号:<span id="boxNumber">${data.boxNumber}</span></p>
                        </div>
                        <div class="info-row">
                            <p>客户:<span id="customer">${data.customer}</span></p>
                            <p>型号:<span id="model">${data.model}</span></p>
                        </div>
                        <div class="info-row">
                            <p>装箱数:<span id="quantity">${data.quantity}</span></p>
                            <p>内外轮:<span id="outerInnerRing">${data.outerInnerRing}</span></p>
                        </div>
                        <div class="info-row">
                            <p>库位:<span id="storageLocation">${data.storageLocation}</span></p>
                            <p>仓库:<span id="depository">${data.depository}</span></p>
                        </div>
                    </div>
                `;
                // Append the information HTML to the QR code container
                qrContainer.append(infoHtml);
                // Append the QR code container to the page
                $(qrCodeElement).append(qrContainer);
                // 显示二维码元素
                document.getElementById('qrcode').style.display = 'block';
                // 隐藏预览模态框
                document.getElementById('preGenerateModal').style.display = 'none';
            })
            .catch(error => {
                console.error('生成二维码时发生错误：', error);
            });
    }
    // 当用户点击“取消”按钮时执行
    function cancelGenerateQRCode() {
        preGenerateData = null;
        document.getElementById('preGenerateModal').style.display = 'none';
        document.getElementById('qrcode').style.display = 'none';
    }
    function prepareOperation(operation) {
        console.log("开始切换")
        currentOperation = operation;
        document.getElementById("scanner-container").style.display = "block";
        html5QrcodeScanner.clear(); // 清除之前的扫描结果
        html5QrcodeScanner.render(onScanSuccess);
    }

    function onScanSuccess(decodedText, decodedResult) {
        try {
            var jsonData;
            try {
                jsonData = JSON.parse(decodedText);
            } catch (jsonError) {
                var base64DecodedData = atob(decodedText);
                var decodedData = decodeURIComponent(escape(base64DecodedData));
                jsonData = JSON.parse(decodedData);
            }

            // 显示扫描成功消息
            showResult('扫描成功: ' + JSON.stringify(jsonData));

            // 一定时间后执行操作
            setTimeout(function() {
                if (currentOperation === "stockIn") {
                    stockIn(jsonData.boxText, jsonData.boxNumber, jsonData.quantity);
                } else if (currentOperation === "stockOut") {
                    stockOut(jsonData.boxText, jsonData.boxNumber, jsonData.quantity);
                }
            }, 2000); // 等待2秒后再执行操作

        } catch (e) {
            console.error('扫描错误:', e);
            showResult('扫描失败: ' + e.message);
        }
    }

    // 入库操作
    function stockIn(boxText, boxNumber, quantity) {
        var inventoryDto = { boxText: boxText,  quantityInStock: quantity };
        fetch('/bearingInventory/stockIn', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(inventoryDto),
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络响应错误');
                }
                // 检查响应是否有内容
                if (response.headers.get("content-type")?.includes("application/json")) {
                    return response.json();
                } else {
                    return null; // 或者返回一个默认的对象，比如 {}
                }
            })
            .then(data => {
                if (data) {
                    showResult('入库成功: ' + JSON.stringify(data));
                } else {
                    showResult('入库成功');
                }
            })
            .catch(error => {
                console.error('入库失败:', error);
                showResult('入库失败: ' + error.message);
            })
            .finally(() => {
                resetScanner(); // 无论成功或失败，重置扫描器
            });
    }

    // 出库操作
    function stockOut(boxText, boxNumber, quantity) {
        var inventoryDto = { boxText: boxText, boxNumber: boxNumber, quantityInStock: quantity };
        fetch('/bearingInventory/stockOut', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(inventoryDto),
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络响应不是OK');
                }
                return response.json();
            })
            .then(data => {
                showResult('出库成功: ' + JSON.stringify(data));
            })
            .catch(error => {
                console.error('出库失败:', error);
                showResult('出库失败: ' + error.message);
            })
            .finally(() => {
                resetScanner(); // 无论成功或失败，重置扫描器
            });
    }

    // 显示扫描结果
    function displayScanResult(result) {
        var resultContainer = document.getElementById('operation-result');
        resultContainer.innerHTML = `扫描结果: ${JSON.stringify(result)}`;
        resultContainer.style.display = "block";
    }

    // 显示操作结果（入库或出库）
    function showResult(message) {
        var resultContainer = document.getElementById('operation-result');
        resultContainer.innerHTML = message + ' <button onclick="resetScanner()">关闭</button>';
        resultContainer.style.display = "block";
    }

    function resetScanner() {
        document.getElementById("scanner-container").style.display = "none";
        currentOperation = null;
        var resultContainer = document.getElementById('operation-result');
        resultContainer.style.display = "none";
        html5QrcodeScanner.clear(); // 清除扫描器的结果和状态
    }
    // function printQRCode() {
    //     var qrCodeDiv = document.getElementById('qrcode');
    //     if (qrCodeDiv.innerHTML.trim() !== '') {
    //         var printWindow = window.open('', '_blank');
    //
    //         // 创建一个新的 div 元素并复制二维码内容
    //         var newDiv = printWindow.document.createElement('div');
    //         newDiv.innerHTML = qrCodeDiv.innerHTML;
    //
    //         // 将新的 div 元素添加到新窗口的 body 中
    //         printWindow.document.body.appendChild(newDiv);
    //
    //         // 添加延迟确保内容加载
    //         setTimeout(function() {
    //             printWindow.print();
    //             printWindow.close();
    //         }, 250);
    //     } else {
    //         alert('请先生成二维码！');
    //     }
    // }
    function printQRCode() {
        window.print();
    }
    function downloadQRCode() {
        var qrCodeCanvas = document.querySelector('#qrcode canvas');
        if (qrCodeCanvas) {
            var image = qrCodeCanvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
            var link = document.createElement('a');
            link.download = 'qrcode.png';
            link.href = image;
            link.click();
        } else {
            alert('请先生成二维码！');
        }
    }
</script>
</body>
</html>
