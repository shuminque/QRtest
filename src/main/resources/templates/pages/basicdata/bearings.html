<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>轴承数据表</title>
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="/static/lib/layui-v2.8.17/css/layui.css" media="all">
    <script src="/static/lib/layui-v2.8.17/layui.js" charset="utf-8"></script>
    <!-- jQuery 库 -->
    <script src="/static/js/http_ajax.googleapis.com_ajax_libs_jquery_3.5.1_jquery.js"></script>
    <style>
        body {
            /*padding-top: 50px;*/
            background-color: #f8f9fa;
        }
        .container {
            margin: 10px;
        }
        .layui-table-view .layui-table { /* 调整表格样式 */
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
<div class="container">
<!--    &lt;!&ndash; 筛选框 &ndash;&gt;-->
<!--    <form class="layui-form" style="margin-bottom: 20px;">-->
<!--        <div class="layui-form-item">-->
<!--            <label class="layui-form-label">交易类型：</label>-->
<!--            <div class="layui-input-inline">-->
<!--                <select name="transactionType" id="transactionType" lay-filter="transactionTypeFilter">-->
<!--                    <option value="">全部</option>-->
<!--                    <option value="入库">入库</option>-->
<!--                    <option value="出库">出库</option>-->
<!--                    <option value="返库">返库</option>-->
<!--                    <option value="转入">转入</option>-->
<!--                    <option value="转出">转出</option>-->
<!--                </select>-->
<!--            </div>-->
<!--        </div>-->
<!--    </form>-->
    <table class="layui-hide" id="recordTable" lay-filter="recordTableFilter"></table>
</div>
<!-- 工具栏模板 -->
<script type="text/html" id="actionBar">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
<!--    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="delete">删除</a>-->
</script>

<!-- 编辑bearings的表单（在弹出层中显示） -->
<script type="text/template" id="editBearingsForm" >
    <form class="layui-form" lay-filter="editForm">
        <!-- ID字段，只读 -->
        <div class="layui-form-item">
            <label class="layui-form-label">ID：</label>
            <div class="layui-input-block">
                <input type="text" name="id" required lay-verify="required" placeholder="请输入ID" autocomplete="off" class="layui-input" readonly>
            </div>
        </div>
        <!-- 箱号 -->
        <div class="layui-form-item">
            <label class="layui-form-label">箱号：</label>
            <div class="layui-input-block">
                <input type="text" name="boxText" required lay-verify="required" placeholder="请输入箱号" autocomplete="off" class="layui-input">
            </div>
        </div>
        <!-- 数量 -->
        <div class="layui-form-item">
            <label class="layui-form-label">数量：</label>
            <div class="layui-input-block">
                <input type="text" name="quantity" required lay-verify="required" placeholder="请输入数量" autocomplete="off" class="layui-input">
            </div>
        </div>
        <!-- 厂区 -->
        <div class="layui-form-item">
            <label class="layui-form-label">厂区：</label>
            <div class="layui-input-block">
                <input type="text" name="depository" placeholder="请输入厂区" autocomplete="off" class="layui-input">
            </div>
        </div>
        <!-- 客户 -->
        <div class="layui-form-item">
            <label class="layui-form-label">客户：</label>
            <div class="layui-input-block">
                <input type="text" name="customer" placeholder="请输入客户" autocomplete="off" class="layui-input">
            </div>
        </div>
        <!-- 外/内轮 -->
        <div class="layui-form-item">
            <label class="layui-form-label">外/内轮：</label>
            <div class="layui-input-block">
                <select name="outerInnerRing">
                    <option value="" selected></option>
                    <option value="LA" >LA</option>
                    <option value="LB" >LB</option>
                </select>
            </div>
        </div>
        <!-- 型号 -->
        <div class="layui-form-item">
            <label class="layui-form-label">型号：</label>
            <div class="layui-input-block">
                <input type="text" name="model" placeholder="请输入型号" autocomplete="off" class="layui-input">
            </div>
        </div>
        <!-- 制品分类 -->
        <div class="layui-form-item">
            <label class="layui-form-label">制品分类：</label>
            <div class="layui-input-block">
                <select name="productCategory">
                    <option value="" selected>搜索制品分类</option>
                    <option th:each="product_category : ${productCategorys}"
                            th:value="${product_category.name}"
                            th:text="${product_category.name}"></option>
                </select>
            </div>
        </div>
        <!-- 钢种 -->
        <div class="layui-form-item">
            <label class="layui-form-label">钢种：</label>
            <div class="layui-input-block">
                <input type="text" name="steelType" placeholder="请输入钢种" autocomplete="off" class="layui-input">
            </div>
        </div>
        <!-- 钢材等级 -->
        <div class="layui-form-item">
            <label class="layui-form-label">钢材等级：</label>
            <div class="layui-input-block">
                <input type="text" name="steelGrade" placeholder="请输入钢材等级" autocomplete="off" class="layui-input">
            </div>
        </div>
        <!-- 材料尺寸 -->
        <div class="layui-form-item">
            <label class="layui-form-label">材料尺寸：</label>
            <div class="layui-input-block">
                <input type="text" name="size" placeholder="请输入材料尺寸" autocomplete="off" class="layui-input">
            </div>
        </div>
        <!-- 关联 -->
        <div class="layui-form-item">
            <label class="layui-form-label">关联：</label>
            <div class="layui-input-block">
                <input type="text" name="pair" placeholder="请输入关联" autocomplete="off" class="layui-input">
            </div>
        </div>
        <!-- 备注 -->
        <div class="layui-form-item">
            <label class="layui-form-label">库位：</label>
            <div class="layui-input-block">
                <input type="text" name="storageLocation" placeholder="请输入库位" autocomplete="off" class="layui-input">
            </div>
        </div>
        <!-- 提交按钮 -->
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button type="submit" class="layui-btn" lay-submit lay-filter="submitEditForm">更新</button>
            </div>
        </div>
    </form>
</script>
<script>
    layui.use(['table', 'form', 'layer'], function(){
        var table = layui.table;
        var form = layui.form;
        var layer = layui.layer;

        // 渲染表格
        var recordTable =  table.render({
            elem: '#recordTable',
            url: '/bearings/all', // 数据接口
            parseData: function(res) { // 将原始数据格式适配成 layui 表格组件所期望的格式
                return {
                    "code": 0, // 解析接口状态
                    "msg": "", // 解析提示文本
                    "count": res.length, // 解析数据长度
                    "data": res // 解析数据列表
                };
            },
            toolbar: ['filter', 'exports', 'print'],
            cols: [ [ // 表头
                {field: 'id', title: 'ID',  hide:true},
                {field: 'pair', title: '关联', edit: 'text'},
                {field: 'boxText', title: '箱号', edit: 'text'},
                {field: 'quantity', title: '数量', edit: 'text'},
                {field: 'depository', title: '厂区'},
                {field: 'customer', title: '客户', edit: 'text'},
                {field: 'outerInnerRing', title: '外/内轮', edit: 'text'},
                {field: 'model', title: '型号', edit: 'text'},
                {field: 'productCategory', title: '制品分类', edit: 'text'},
                {field: 'steelType', title: '钢种', edit: 'text'},
                {field: 'steelGrade', title: '钢材等级', edit: 'text'},
                {field: 'size', title: '材料尺寸', edit: 'text'},
                {field: 'storageLocation', title: '库位', edit: 'text'},
                {title: '操作', toolbar: '#actionBar'} // 添加操作列
            ]],
            limits:[300,500,1000],
            limit:300,
            page: true //开启分页
        });
        // 监听筛选框的选择事件
        form.on('select(transactionTypeFilter)', function(data){
            var req = {};
            console.log(data);
            if(data.value !== '') {
                req.transactionType = data.value; // 使用 data.value 获取选择的交易类型
            }
            // 重新加载表格数据
            recordTable.reload({
                url: '/bearings/all', // 数据接口
                where: req
            });
            return false;
        });
        // 监听表格的编辑按钮事件
        table.on('tool(recordTableFilter)', function(obj){
            var data = obj.data; // 获取当前行的数据
            var layEvent = obj.event; // 获得 lay-event 对应的值（也就是自定义的事件名）
            if(layEvent=== 'edit'){
                // 编辑操作
                editBearings(data);
            } else if(layEvent === 'delete'){
                // 删除操作
                console.log("sc删除删除删除")
            }
        });
        // 编辑bearings的函数
        function editBearings(data) {
            layer.open({
                type: 1,
                title: '编辑Bearings数据',
                content: $('#editBearingsForm').html(),
                area: ['500px', '400px'], // 根据需要调整弹窗大小
                success: function(layero, index){
                    // 填充表单数据
                    form.val('editForm', {
                        'id': data.id, // ID，假设这是从表格行数据获取的
                        'boxText': data.boxText, // 箱号
                        'quantity': data.quantity, // 数量
                        'depository': data.depository, // 厂区
                        'customer': data.customer, // 客户
                        'outerInnerRing': data.outerInnerRing, // 外/内轮
                        'model': data.model, // 型号
                        'productCategory': data.productCategory, // 制品分类
                        'steelType': data.steelType, // 钢种
                        'steelGrade': data.steelGrade, // 钢材等级
                        'size': data.size, // 材料尺寸
                        'pair': data.pair,
                        'storageLocation': data.storageLocation // 备注
                    });
                    layui.form.render();
                }
            });
        }
        // 处理表单提交事件
        form.on('submit(submitEditForm)', function(data){
            var formData = data.field; // 获取表单数据
            console.log(formData); // 调试输出，检查formData中的id值

            // 确保formData.id存在且不是undefined
            if(formData.id === undefined) {
                layer.msg('ID值未定义');
                return false; // 阻止表单提交
            }

            // 发送AJAX请求更新数据
            $.ajax({
                url: '/bearings/' + formData.id, // 使用formData中的id
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response){
                    layer.msg('更新成功');
                    table.reload('recordTable'); // 重新加载表格数据
                    layer.closeAll(); // 关闭弹出层
                },
                error: function(){
                    layer.msg('更新失败');
                }
            });

            return false; // 阻止表单跳转。
        });


        // table.on('edit(recordTableFilter)', function(obj) {
        //     var value = obj.value; // 获取编辑后的值
        //     var data = obj.data; // 获取整行数据
        //     var field = obj.field; // 获取编辑的字段
        //
        //     if (field !== 'depository') {
        //         // 只有当编辑的字段是“溶解号”时才处理
        //         data.dissolve = value;
        //         // 发送AJAX请求更新后端数据
        //         layer.confirm('确定要更新吗？', function (index) {
        //             $.ajax({
        //                 url: '/bearings/' + data.id, // 更新API URL
        //                 type: 'PUT',
        //                 contentType: 'application/json',
        //                 data: JSON.stringify(data), // 发送整个更新后的数据对象
        //                 success: function(response) {
        //                     layer.msg('更新成功');
        //                 },
        //                 error: function(xhr, status, error) {
        //                     layer.msg('更新失败: ' + error);
        //                     // 错误处理
        //                 }
        //             });
        //             layer.close(index);
        //         });
        //     }
        // });
    });
</script>
</body>
</html>
